(function(b){function h(){}function f(b){if(!b)return 0;b=b.split(".");return 1E4*parseInt(b[0])+100*parseInt(b[1])+parseInt(b[2])}function n(b){for(var b=b.replace(/-/g,"_"),b=b.split("."),g=k,e=0;e<b.length;e++)g[b[e]]===void 0&&(g[b[e]]=new h),g=g[b[e]];return g}var k=b.namespace;if(k){if(f("3.0.1")<=f(k.VERSION))return;h=k.constructor}else b.namespace=k=new h;k.VERSION="3.0.1";b=h.prototype;b.module=function(b,g){var e=n(b);g&&g(e,n);return e};b.extend=function(b){for(var g in b)b.hasOwnProperty(g)&&
(this[g]=b[g])}})(this);
namespace.module("org.startpad.types",function(b){function h(b,e){return f(b)==e}function f(b){if(b===void 0)return"undefined";if(b===null)return"null";var e=Object.prototype.toString.call(b).match(/\[object (.*)\]/)[1].toLowerCase();n.indexOf(e)==-1&&(e=typeof b);return e}b.extend({VERSION:"0.1.0",isArguments:function(b){return h(b,"arguments")},isArray:function(b){return h(b,"array")},copyArray:function(b){return Array.prototype.slice.call(b)},isType:h,typeOf:f,extend:function(b){var e,c,j,d;b===
void 0&&(b={});for(e=1;e<arguments.length;e++){j=arguments[e];for(d in j)j.hasOwnProperty(d)&&(b[d]=j[d]);if(k)for(c=0;c<m.length;c++)d=m[c],j.hasOwnProperty(d)&&(b[d]=j[d])}return b},project:function(b,e){for(var c={},j=0;j<e.length;j++){var d=e[j];b&&b.hasOwnProperty(d)&&(c[d]=b[d])}return c},getFunctionName:function(b){if(typeof b=="function"){b=b.toString().match(/function\s*(\S+)\s*\(/);if(!b)return"";return b[1]}}});var n=["number","string","boolean","array","function","date","regexp","arguments",
"undefined","null"],k=!{toString:!0}.propertyIsEnumerable("toString"),m=["toString","toLocaleString","valueOf","constructor","isPrototypeOf"]});
namespace.module("org.startpad.funcs",function(b,h){function f(b){if(!b)return 0;b=b.split(".");return 1E4*parseInt(b[0])+100*parseInt(b[1])+parseInt(b[2])}function n(b,d,c,e){if(!(b._patches&&f(b._patches[d])>=f(c)))b._patches=b._patches||{},b._patches[d]=c,k(b,e)}function k(b,c){d.extend(b.prototype,c)}function m(b,c){function e(b,c){for(var r=d.copyArray(b),c=d.copyArray(c),j=0;j<r.length;j++)r[j]===void 0&&(r[j]=c.shift());return r.concat(c)}var j;j=arguments.length==3&&d.isArguments(arguments[2])?
Array.prototype.slice.call(arguments[2],self1):Array.prototype.slice.call(arguments,2);return function(){return b.apply(c||this,e(j,arguments))}}function g(b,c){function d(){return c.call(this,b,arguments,d)}c.call(b,void 0,arguments,d);return d}function e(b){function c(){}c.prototype=b;return new c}function c(c,d,j){c.prototype=b.create(d.prototype);c.prototype.constructor=c;k(c,j)}function j(c,j){for(var e=c.pop().prototype,f;c.length>0;){f=c.pop();var g=d.getFunctionName(f),i=b.create(e);d.extend(i,
f.prototype);i.constructor=f;i[g+"_super"]=e;e=i}f.prototype=e;k(f,j)}var d=h("org.startpad.types");b.extend({VERSION:"0.3.0",methods:k,bind:m,decorate:g,create:Object.create||e,subclass:c,mro:j,numericVersion:f,monkeyPatch:n,patch:function(){n(Function,"org.startpad.funcs",b.VERSION,{methods:function(b){k(this,b)},curry:function(){var b=[this,void 0].concat(d.copyArray(arguments));return m.apply(void 0,b)},curryThis:function(){var b=d.copyArray(arguments);b.unshift(this);return m.apply(void 0,b)},
decorate:function(b){return g(this,b)},subclass:function(b,d){c(this,b,d)},mro:function(b,c){b.unshift(this);j(b,c)}});return b}})});
namespace.module("org.startpad.string",function(b,h){function f(b,f,e){e=e||k;if(b==void 0)return"undefined";b=b.toString();return b=b.replace(e,function(b,j){for(var d=f,e=j.split("."),h=0;h<e.length;h++){var j=e[h],n=parseInt(j),d=isNaN(n)?d[j]:d[n];if(d==void 0)return""}return d})}var n=h("org.startpad.funcs");b.extend({VERSION:"0.1.2",patch:function(){n.monkeyPatch(String,"org.startpad.string",b.VERSION,{format:function(){return arguments.length==1&&typeof arguments[0]=="object"?f(this,arguments[0]):
f(this,arguments)}});return b},format:f});var k=/\{\s*([^} ]+)\s*\}/g});(function(b){b.fn.autoResize=function(h){var f=b.extend({onResize:function(){},animate:!0,animateDuration:150,animateCallback:function(){},extraSpace:20,limit:1E3},h);this.filter("textarea").each(function(){var h=b(this).css({resize:"none","overflow-y":"hidden"}),k=h.height(),m=function(){var c={};b.each(["height","width","lineHeight","textDecoration","letterSpacing"],function(b,d){c[d]=h.css(d)});return h.clone().removeAttr("id").removeAttr("name").css({position:"absolute",top:0,left:-9999}).css(c).attr("tabIndex",
"-1").insertBefore(h)}(),g=null,e=function(){m.height(0).val(b(this).val()).scrollTop(1E4);var c=Math.max(m.scrollTop(),k)+f.extraSpace,e=b(this).add(m);if(c>=f.limit)b(this).css("overflow-y",""),c=f.limit;g!==c&&(g=c,f.onResize.call(this),f.animate&&h.css("display")==="block"?e.stop().animate({height:c},f.animateDuration,f.animateCallback):e.height(c))};h.unbind(".dynSiz").bind("keyup.dynSiz",e).bind("keydown.dynSiz",e).bind("change.dynSiz",e).trigger("change.dynSiz")});return this}})(jQuery);var Showdown={converter:function(){var b,h,f,n=0;this.makeHtml=function(a){b=[];h=[];f=[];a=a.replace(/~/g,"~T");a=a.replace(/\$/g,"~D");a=a.replace(/\r\n/g,"\n");a=a.replace(/\r/g,"\n");a=z("\n\n"+a+"\n\n");a=a.replace(/^[ \t]+$/mg,"");a=m(a);a=k(a);a=e(a);a=A(a);a=a.replace(/~D/g,"$$");return a=a.replace(/~T/g,"~")};var k=function(a){return a=a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|\Z)/gm,function(a,l,c,d,e){l=l.toLowerCase();b[l]=
w(c);if(d)return d+e;else e&&(h[l]=e.replace(/"/g,"&quot;"));return""})},m=function(a){a=a.replace(/\n/g,"\n\n");a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,g);a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,g);a=a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,g);a=a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,
g);a=a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,g);return a=a.replace(/\n\n/g,"\n")},g=function(a,b){var l;l=b.replace(/\n\n/g,"\n");l=l.replace(/^\n/,"");l=l.replace(/\n+$/g,"");return l="\n\n~K"+(f.push(l)-1)+"K\n\n"},e=function(a){for(var a=v(a),b=i("<hr />"),a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,b),a=s(a),a=q(a),a=B(a),a=m(a),a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,
""),l=a.split(/\n{2,}/g),a=[],b=l.length,d=0;d<b;d++){var e=l[d];e.search(/~K(\d+)K/g)>=0?a.push(e):e.search(/\S/)>=0&&(e=c(e),e=e.replace(/^([ \t]*)/g,"<p>"),e+="</p>",a.push(e))}b=a.length;for(d=0;d<b;d++)for(;a[d].search(/~K(\d+)K/)>=0;)l=f[RegExp.$1],l=l.replace(/\$/g,"$$$$"),a[d]=a[d].replace(/~K\d+K/,l);return a=a.join("\n\n")},c=function(a){a=o(a);a=j(a);a=a.replace(/\\(\\)/g,x);a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,x);a=a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,r);a=a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,
r);a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,d);a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,d);a=a.replace(/(\[([^\[\]]+)\])()()()()()/g,d);a=C(a);a=w(a);a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>");a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>");return a=a.replace(/  +\n/g," <br />\n")},j=function(a){return a=a.replace(/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi,
function(a){a=a.replace(/(.)<\/?code>(?=.)/g,"$1`");return a=t(a,"\\`*_")})},d=function(a,c,l,d,e,j,f,i){i==void 0&&(i="");a=d.toLowerCase();if(e=="")if(a==""&&(a=l.toLowerCase().replace(/ ?\n/g," ")),b[a]!=void 0)e=b[a],h[a]!=void 0&&(i=h[a]);else if(c.search(/\(\s*\)$/m)>-1)e="";else return c;e=t(e,"*_");c='<a href="'+e+'"';i!=""&&(i=i.replace(/"/g,"&quot;"),i=t(i,"*_"),c+=' title="'+i+'"');c+=">"+l+"</a>";return c},r=function(a,c,l,d,e,j,i,f){a=l;d=d.toLowerCase();f||(f="");if(e=="")if(d==""&&
(d=a.toLowerCase().replace(/ ?\n/g," ")),b[d]!=void 0)e=b[d],h[d]!=void 0&&(f=h[d]);else return c;a=a.replace(/"/g,"&quot;");e=t(e,"*_");c='<img src="'+e+'" alt="'+a+'"';f=f.replace(/"/g,"&quot;");f=t(f,"*_");c+=' title="'+f+'"';c+=" />";return c},v=function(a){a=a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(a,b){return i("<h1>"+c(b)+"</h1>")});a=a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(a,b){return i("<h2>"+c(b)+"</h2>")});return a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(a,
b,d){a=b.length;return i("<h"+a+">"+c(d)+"</h"+a+">")})},p,s=function(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;n?a=a.replace(b,function(a,b,c){a=b;c=c.search(/[*+-]/g)>-1?"ul":"ol";a=a.replace(/\n{2,}/g,"\n\n\n");a=p(a);a=a.replace(/\s+$/,"");return"<"+c+">"+a+"</"+c+">\n"}):(b=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,a=a.replace(b,function(a,b,c,d){a=c;d=d.search(/[*+-]/g)>
-1?"ul":"ol";a=a.replace(/\n{2,}/g,"\n\n\n");a=p(a);return b+"<"+d+">\n"+a+"</"+d+">\n"}));return a=a.replace(/~0/,"")};p=function(a){n++;a=a.replace(/\n{2,}$/,"\n");a+="~0";a=a.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(a,b,d,f,j){a=j;b||a.search(/\n{2,}/)>-1?a=e(y(a)):(a=s(y(a)),a=a.replace(/\n$/,""),a=c(a));return"<li>"+a+"</li>\n"});a=a.replace(/~0/g,"");n--;return a};var q=function(a){a+="~0";a=a.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,
function(a,b,c){a=u(y(b));a=z(a);a=a.replace(/^\n+/g,"");a=a.replace(/\n+$/g,"");return i("<pre><code>"+a+"\n</code></pre>")+c});return a=a.replace(/~0/,"")},i=function(a){a=a.replace(/(^\n+|\n+$)/g,"");return"\n\n~K"+(f.push(a)-1)+"K\n\n"},o=function(a){return a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(a,b,c,d){a=d.replace(/^([ \t]*)/g,"");a=a.replace(/[ \t]*$/g,"");a=u(a);return b+"<code>"+a+"</code>"})},u=function(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,
"&gt;");return a=t(a,"*_{}[]\\",!1)},B=function(a){return a=a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(a,b){var c;c=b.replace(/^[ \t]*>[ \t]?/gm,"~0");c=c.replace(/~0/g,"");c=c.replace(/^[ \t]+$/gm,"");c=e(c);c=c.replace(/(^|\n)/g,"$1  ");c=c.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(a,b){var c;c=b.replace(/^  /mg,"~0");return c=c.replace(/~0/g,"")});return i("<blockquote>\n"+c+"\n</blockquote>")})},w=function(a){a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;");return a=
a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},C=function(a){a=a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>');return a=a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(a,b){return D(A(b))})},D=function(a){var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){a=a.charCodeAt(0);return"&#x"+("0123456789ABCDEF".charAt(a>>4)+"0123456789ABCDEF".charAt(a&15))+";"},function(a){return a}],a=("mailto:"+a).replace(/./g,function(a){if(a=="@")a=b[Math.floor(Math.random()*
2)](a);else if(a!=":")var c=Math.random(),a=c>0.9?b[2](a):c>0.45?b[1](a):b[0](a);return a});return a=('<a href="'+a+'">'+a+"</a>").replace(/">.+:/g,'">')},A=function(a){return a=a.replace(/~E(\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)})},y=function(a){a=a.replace(/^(\t|[ ]{1,4})/gm,"~0");return a=a.replace(/~0/g,"")},z=function(a){a=a.replace(/\t(?=\t)/g,"    ");a=a.replace(/\t/g,"~A~B");a=a.replace(/~B(.+?)~A/g,function(a,b){for(var c=b,d=4-c.length%4,e=0;e<d;e++)c+=" ";
return c});a=a.replace(/~A/g,"    ");return a=a.replace(/~B/g,"")},t=function(a,b,c){b="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";c&&(b="\\\\"+b);return a=a.replace(RegExp(b,"g"),x)},x=function(a,b){return"~E"+b.charCodeAt(0)+"E"}}};var clientLib=require("com.pageforest.client"),dom=require("org.startpad.dom"),nsdoc=require("org.startpad.nsdoc"),format=require("org.startpad.format"),markdown=new Showdown.converter;exports.extend({onReady:onReady,getDoc:getDoc,setDoc:setDoc,onSaveSuccess:onSaveSuccess});var client,doc,blob,lastText="",syncTime=5,editVisible=!1,editorInitialized=!1;
function onEditChange(){var b=doc.editor.value;if(b!=lastText){client.setDirty();lastText=b;try{doc.output.innerHTML=markdown.makeHtml(b),nsdoc.updateScriptSections(doc.output)}catch(h){$(doc.output).text("Error: "+h.message)}}}function toggleEditor(){(editVisible=!editVisible)?($(doc.page).addClass("edit"),editorInitialized||(editorInitialized=!0,$(doc.editor).bind("keyup",onEditChange).autoResize({limit:1E4}))):$(doc.page).removeClass("edit");$(doc.edit).val(editVisible?"hide":"edit")}
function onReady(){handleAppCache();doc=dom.bindIDs();client=new clientLib.Client(exports);client.saveInterval=0;client.addAppBar();$(doc.edit).click(toggleEditor);setInterval(onEditChange,syncTime*1E3)}function updateMeta(b){document.title=b.title;$("#title").text(b.title)}function onSaveSuccess(){updateMeta(client.meta)}function setDoc(b){doc.editor.value=b.blob.markdown;onEditChange();updateMeta(b)}function getDoc(){return{blob:{version:1,markdown:doc.editor.value},readers:["public"]}}
function handleAppCache(){typeof applicationCache!="undefined"&&(applicationCache.status==applicationCache.UPDATEREADY?(applicationCache.swapCache(),location.reload()):applicationCache.addEventListener("updateready",handleAppCache,!1))};namespace.lookup("org.startpad.nsdoc").defineOnce(function(b){function h(b,f){var d=new n.StBuf,g=b.split(".").length;d.append(k.repeat("#",g)+" *"+b+"*(");g=m.exec(f.toString());if(g===null)return"error reading function: "+b+"\n";var g=g[1].split(e),v="";if(g.length>1||g[0]!="")d.append("*"+g.join("*, *")+"*"),v=", ";f.toString().indexOf("arguments")!=-1&&d.append(v+"...");d.append(")\n");var b=b[0].toLowerCase()+b.slice(1),p;for(p in f.prototype)typeof f.prototype[p]=="function"&&d.append(h(b+"."+
p,f.prototype[p]));return d.toString()}function f(b){if(typeof b!="function")return"notAFunction";b=g.exec(b.toString());if(b==null)return"anonymous";return b[1]}var n=namespace.lookup("org.startpad.base"),k=namespace.lookup("org.startpad.format"),m=/^function\s+\S*\(([^\)]*)\)/,g=/function\s+(\S+)\s*\(/,e=/\s*,\s/;b.extend({namespaceDoc:function(b){var e=new n.StBuf,d;for(d in b)if(b.hasOwnProperty(d)){var f=b[d];typeof f!="function"||d=="_closure"||e.append(h(d,f))}return e.toString()},updateScriptSections:function(b){for(var b=
$("script",b),e,d=0;d<b.length;d++){var h=b[d];e=[];for(var g=n.strip(h.innerHTML),g=g.split("\n"),m=[],s=0,q=0,i=0;i<g.length;i++)if(i!=g.length-1&&!/^\S.*;\s*$/.test(g[i]))m[i]="";else{q=g.slice(q,i+1).join("\n");q=n.strip(q);try{var o=eval(q);if(o==void 0)m[i]="";else{typeof o=="string"&&(o='"'+o+'"',o.replace(/"/g,'""'));typeof o=="function"&&(o="function "+f(o));if(typeof o=="object")if(o===null)o="null";else{var u=f(o.constructor)+": ";try{o=u+JSON.stringify(o)}catch(B){o+=u+"{...}"}}m[i]="// "+
o.toString()}}catch(w){m[i]="// Exception: "+w.message}s=Math.max(g[i].length,s);q=i+1}for(i=0;i<g.length;i++)m[i]!=""&&(g[i]+=k.repeat(" ",s-g[i].length+2)+m[i]);g=g.join("\n");$(h).before("<pre><code>"+k.escapeHTML(g)+"</code></pre>");e.length>0&&$(h).after('<pre class="printed"><code>'+k.escapeHTML(e.join("\n"))+"</code></pre>")}}})});